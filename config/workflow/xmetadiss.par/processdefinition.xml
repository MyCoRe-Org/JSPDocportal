<?xml version="1.0" encoding="UTF-8"?>

<process-definition
  xmlns="urn:jbpm.org:jpdl-3.1"  name="xmetadiss">

  <!-- SWIMLANES (= process roles) -->

  <swimlane name="initiator" />
  
  <swimlane name="disseditor">
	<assignment class="org.mycore.frontend.workflowengine.jbpm.MCRPooledActorAssignmentHandler">
		<groupName>editorgroup1</groupName>
	</assignment>  
  </swimlane>
  
  <swimlane name="subjectExpert">
    <!--   <assignment expression="user(ernie)" /> -->
  </swimlane>  
  
  <start-state name="start">
     <task name="initialization" swimlane="initiator">
     </task>     
     <transition name="go2processInitialized" to="processInitialized" />
  </start-state>

  <state name="processInitialized">
     <event type='node-enter'>
        <action class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRGetAuthorAction" />
     </event>
     <transition name="go2authorCreated" to="authorCreated" />  
  </state>
  
  <state name="authorCreated">
     <event type='node-enter'>
        <action class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRGetURNAction" />        
     </event>  
  	<transition name="go2urnCreated" to="urnCreated" />
  </state>
  
  <state name="urnCreated">
     <event type='node-enter'>
        <action class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRCreateDisshabAction" />        
     </event>      
  	<transition name="go2disshabCreated" to="disshabCreated" />
  </state>
  
  <task-node name="disshabCreated">
     <task name="completeDisshabAndSendToLibrary" swimlane="initiator" />
     <transition name="go2canDisshabBeSubmitted" to="canDisshabBeSubmitted" />
  </task-node>

  <decision name="canDisshabBeSubmitted">
     <handler class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRCanDisshabBeSubmittedDecisionHandler" />
     <transition name="disshabCantBeSubmitted" to="disshabCreated" />
     <transition name="disshabCanBeSubmitted" to="disshabSubmitted" />
  </decision>
  
  <task-node name="disshabSubmitted">
     <event type='node-enter'>
        <action class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRDisshabSubmittedAction">
           <lockedVariables>initiator,createdDocID,authorID,reservatedURN,attachedDerivates</lockedVariables>
        </action>
     </event> 
     <task name="taskCheckCompleteness" swimlane="disseditor">
     </task> 
     <transition name="go2sendBackToDisshabCreated" to="sendBackToDisshabCreated" >
        <action class="org.mycore.frontend.workflowengine.jbpm.MCRSetDefaultAclsAction">
            <varmcrid>createdDocID</varmcrid>
            <varuserid>initiator</varuserid>
        </action>
     </transition>
     <transition name="go2canDisshabBeCommitted" to="canDisshabBeCommitted" />
  </task-node>
  
  <task-node name="sendBackToDisshabCreated">
     <task name="taskEnterMessageData" swimlane="disseditor" />
     <transition name="go2disshabCreated2" to="disshabCreated" />
  </task-node>
  
  <decision name="canDisshabBeCommitted">
     <handler class="org.mycore.frontend.workflowengine.jbpm.xmetadiss.MCRCanDisshabBeCommittedDecisionHandler" />
     <transition name="disshabCantBeCommitted" to="disshabSubmitted" />
     <transition name="disshabCanBeCommitted" to="disshabCommitted" />
  </decision>  
  
  <state name="disshabCommitted">
     <transition name="to do next" to="todonext" />
  </state>
      
  <!-- 
  <state name="disshabCreated">
     <transition name="todo next" to="todonext" />
  </state>
  -->
  
  <state name="todonext">
    <transition to="end" />
  </state>
  
  <end-state name="end" />
  
</process-definition>